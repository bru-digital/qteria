// This is your Prisma schema file
// Maps to the existing PostgreSQL database created by Alembic migrations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Note: Auth.js tables (Account, Session, VerificationToken) are NOT included
// because we use JWT-only session strategy. These tables do not exist in the database.

// Existing application models (mapped to match SQLAlchemy schema)
model Organization {
  id                  String   @id @default(uuid()) @db.Uuid
  name                String   @db.VarChar(255)
  subscriptionTier    String   @default("trial") @map("subscription_tier") @db.VarChar(50)
  subscriptionStatus  String   @default("trial") @map("subscription_status") @db.VarChar(50)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  users       User[]
  workflows   Workflow[]
  assessments Assessment[]
  auditLogs   AuditLog[]

  @@map("organizations")
}

model User {
  id             String       @id @default(uuid()) @db.Uuid
  organizationId String       @map("organization_id") @db.Uuid
  email          String       @unique @db.VarChar(255)
  name           String?      @db.VarChar(255)
  passwordHash   String?      @map("password_hash") @db.VarChar(255)
  role           String       @db.VarChar(50)
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)

  organization        Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdWorkflows    Workflow[]     @relation("WorkflowCreator")
  createdAssessments  Assessment[]   @relation("AssessmentCreator")

  @@index([organizationId], map: "idx_user_organization")
  @@map("users")
}

model Workflow {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  createdBy      String?  @map("created_by") @db.Uuid
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization   @relation(fields: [organizationId], references: [id])
  creator      User?          @relation("WorkflowCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  buckets      Bucket[]
  criteria     Criteria[]
  assessments  Assessment[]

  @@index([organizationId], map: "idx_workflow_organization")
  @@index([isActive], map: "idx_workflow_active")
  @@map("workflows")
}

model Bucket {
  id         String   @id @default(uuid()) @db.Uuid
  workflowId String   @map("workflow_id") @db.Uuid
  name       String   @db.VarChar(255)
  required   Boolean  @default(true)
  orderIndex Int?     @map("order_index")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  workflow            Workflow              @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  assessmentDocuments AssessmentDocument[]

  @@index([workflowId], map: "idx_bucket_workflow")
  @@map("buckets")
}

model Criteria {
  id                   String   @id @default(uuid()) @db.Uuid
  workflowId           String   @map("workflow_id") @db.Uuid
  name                 String   @db.VarChar(255)
  description          String   @db.Text
  appliesToBucketIds   String[] @map("applies_to_bucket_ids") @db.Uuid
  exampleText          String?  @map("example_text") @db.Text
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  workflow          Workflow           @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  assessmentResults AssessmentResult[]

  @@index([workflowId], map: "idx_criteria_workflow")
  @@map("criteria")
}

model Assessment {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  workflowId     String    @map("workflow_id") @db.Uuid
  createdBy      String?   @map("created_by") @db.Uuid
  status         String    @default("pending") @db.VarChar(50)
  startedAt      DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs     Int?      @map("duration_ms")

  organization        Organization         @relation(fields: [organizationId], references: [id])
  workflow            Workflow             @relation(fields: [workflowId], references: [id])
  creator             User?                @relation("AssessmentCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  assessmentDocuments AssessmentDocument[]
  assessmentResults   AssessmentResult[]

  @@index([organizationId, status], map: "idx_assessment_organization_status")
  @@index([status], map: "idx_assessment_status")
  @@index([startedAt], map: "idx_assessment_created_at")
  @@map("assessments")
}

model AssessmentDocument {
  id            String   @id @default(uuid()) @db.Uuid
  assessmentId  String   @map("assessment_id") @db.Uuid
  bucketId      String   @map("bucket_id") @db.Uuid
  fileName      String   @map("file_name") @db.VarChar(255)
  storageKey    String   @map("storage_key") @db.VarChar(500)
  fileSizeBytes Int?     @map("file_size_bytes")
  uploadedAt    DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  bucket     Bucket     @relation(fields: [bucketId], references: [id])

  @@index([assessmentId], map: "idx_assessment_document")
  @@map("assessment_documents")
}

model AssessmentResult {
  id              String   @id @default(uuid()) @db.Uuid
  assessmentId    String   @map("assessment_id") @db.Uuid
  criteriaId      String   @map("criteria_id") @db.Uuid
  passStatus      Boolean  @map("pass_status")
  confidence      String?  @db.VarChar(50)
  evidencePage    Int?     @map("evidence_page")
  evidenceSection String?  @map("evidence_section") @db.Text
  reasoning       String?  @db.Text
  aiResponseRaw   Json?    @map("ai_response_raw")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  criteria   Criteria   @relation(fields: [criteriaId], references: [id])

  @@index([assessmentId], map: "idx_result_assessment")
  @@index([criteriaId], map: "idx_result_criteria")
  @@map("assessment_results")
}

model AuditLog {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  userId          String?   @map("user_id") @db.Uuid
  action          String    @db.VarChar(100)
  resourceType    String?   @map("resource_type") @db.VarChar(50)
  resourceId      String?   @map("resource_id") @db.Uuid
  actionMetadata  Json?     @map("action_metadata")
  ipAddress       String?   @map("ip_address") @db.VarChar(45)
  userAgent       String?   @map("user_agent") @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId], map: "idx_audit_organization")
  @@index([userId], map: "idx_audit_user")
  @@index([createdAt], map: "idx_audit_created_at")
  @@index([action], map: "idx_audit_action")
  @@map("audit_logs")
}

// Alembic version table (preserve for migrations)
model AlembicVersion {
  versionNum String @id @map("version_num") @db.VarChar(32)

  @@map("alembic_version")
}
