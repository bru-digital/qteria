# [STORY-034] Generate PDF Report API

**Epic**: EPIC-08 - Reporting & Export
**Priority**: P1 (Important for Launch)
**Estimated Effort**: 2 days
**Journey Step**: Step 5 - Export Report

---

## User Story

**As a** Project Handler
**I want to** generate a PDF validation report
**So that** I can forward professional documentation to Certification Person

---

## Acceptance Criteria

- [ ] POST /v1/assessments/:id/reports generates PDF
- [ ] Report includes all criteria results with evidence
- [ ] Shows assessment metadata (workflow name, date, user)
- [ ] Professional formatting matching brand
- [ ] PDF generation <10 seconds
- [ ] File size <1MB
- [ ] Stored in Vercel Blob

---

## Technical Details

**Tech Stack**:
- Library: ReportLab or WeasyPrint (Python PDF generation)
- Storage: Vercel Blob
- Template: HTML → PDF conversion

**API Endpoint**:
```python
POST /v1/assessments/{assessment_id}/reports
```

**Implementation**:
```python
from weasyprint import HTML, CSS

@router.post("/assessments/{assessment_id}/reports")
async def generate_report(
    assessment_id: str,
    user: User = Depends(get_current_user)
):
    assessment = await db.get_assessment(assessment_id)
    if assessment.organization_id != user.organization_id:
        raise HTTPException(403)

    # Render HTML template
    html_content = render_template(
        "report_template.html",
        assessment=assessment,
        workflow=assessment.workflow,
        results=assessment.results
    )

    # Convert HTML → PDF
    pdf_bytes = HTML(string=html_content).write_pdf()

    # Upload to Vercel Blob
    blob_url = await upload_to_vercel_blob(
        filename=f"report_{assessment_id}.pdf",
        content=pdf_bytes
    )

    # Save report record
    report = await db.create_report(
        assessment_id=assessment_id,
        blob_url=blob_url,
        generated_at=datetime.utcnow()
    )

    return {"report_id": report.id, "blob_url": blob_url}
```

**Report Template Structure**:
```
┌─────────────────────────────────────────┐
│ Qteria Validation Report                │
│                                         │
│ Workflow: Medical Device - Class II    │
│ Completed: 2026-01-15 14:32 UTC        │
│ Assessed by: handler@tuvsud.com        │
│                                         │
│ Overall Status: 3/5 Criteria Passed    │
│                                         │
│ ✅ Criteria 1: Signatures present      │
│    Status: PASS                         │
│    Confidence: High                     │
│    Evidence: All documents signed       │
│                                         │
│ ❌ Criteria 2: Test summary missing    │
│    Status: FAIL                         │
│    Confidence: High                     │
│    Evidence: test-report.pdf, page 8   │
│                                         │
│ Generated by Qteria on 2026-01-15      │
└─────────────────────────────────────────┘
```

---

## RICE Score

**RICE**: (80 × 2 × 0.80) ÷ 2 = **64**

---

## Definition of Done

- [ ] POST endpoint working
- [ ] PDF generated with WeasyPrint
- [ ] Includes all assessment data
- [ ] Professional formatting
- [ ] Stored in Vercel Blob
- [ ] Generation time <10 seconds
- [ ] File size <1MB
- [ ] Tests pass
- [ ] Code reviewed and merged
